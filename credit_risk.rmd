---
title: "Credit Risk"
author: "Filip Mordarski & Mateusz Wasielewski"
date: "5 12 2020"
output: 
  pdf_document:
header-includes: \usepackage[polish]{babel}
toc: yes
toc_depth: 2
number_sections: yes
---

```{r, include=FALSE}
library(generator)
library(dplyr)
library(rjson)
library(ggplot2)
library(moments)
library(knitr)

# paths
#################################################

base_path <- getwd()
output_path <- paste0(base_path, "/data")

# libnames
#################################################


clients <- read.csv2(paste0(output_path, "/clients.csv"))
loans <- read.csv2(paste0(output_path, "/loans.csv"))

data <- left_join(clients, loans, by='ID')
data <- data[-8]
```

# Wstęp

Poniższy raport będzie zawierał analizę modelu ryzyka kredytowego.

# Tworzenie zmiennych objaśniających

W pierwszej kolejności zostały utworzone zmienne objaśniające potrzebne do modelu PD. Pierwszą zmienną, która została wygenerowana na podstawie utworzonych wcześniej zmiennych jest wiek. Został wyliczony okres trwania umowy w latach na podstawie różnicy między obecną datą a wartością w zmiennej *agreement_start*. Następnie został wygenerowany wektor wartości z rozkładu gamma z parametrem kształtu równym 3 oraz parametrem skali równym 2. Wiek został wyznaczony dodając do siebie: czas trwania umowy, liczbę 18 (wiek kiedy człowiek może podpisać wiążącą umowę kredytową) oraz wylosowaną wartość z rozkładu gamma, oznaczającą różnicę w latach pomiędzy datą podpisania umowy a osiągnięciem pełnoletności. Poniższy wykres przedstawia gęstość tej utworzonej zmiennej w naszym zbiorze.

```{r, echo=FALSE, include=T}
# tworzenie zmiennych
set.seed(1892)
# sprawdzamy czas trwania umow
agreement_time <- abs(as.numeric((Sys.Date()-as.Date(data$agreement_start))/365))
data$age <- round(agreement_time+18+rgamma(5000,shape=5,scale=1),0)
plot(density(data$age), main='Wykres gęstości wieku', ylab='Gęstość')
```

Następnie została wygenerowana zmienna, która określa czy dany pracownik jest zatrudniony, czy też nie. Prawdopodobieństwo bezrobocia zostało ustalone na poziomie 3.6 %. Wartość ta odzwierciedla średnią stopę bezrobocia w 2019 roku w Stanach Zjednoczonych. Poniższy wykres przedstawia histogram tej zmiennej w zbiorze.


```{r, echo=FALSE, include=T}
data$employed <- sample.int(2, 5000, replace = T, prob = c(0.036, 0.964))-1

ggplot(data, aes(x = factor(employed))) +
  geom_bar(fill = "#0073C2FF", stat = "count")+
  scale_x_discrete(breaks=c(0,1), labels=c("Nie", "Tak"))+
  labs(title='Histogram zmiennej, określająca czy klient jest zatrudniony',x='', y="Częstość")+
  theme_minimal()
```

Na podstawie zmiennej, określającej czy dana osoba jest zatrudniona, wygenerowano zmienną czy dana osoba jest zatrudniona na pełny etat. Prawdopodobieństwo tego wynosi 80 %. Poniższy wykres przedstawia histogram tej zmiennej.

```{r, echo=F}
data$full_time <- 0
data[data$employed==1,"full_time"] <- sample.int(2, nrow(data[data$employed==1,]), replace = T, prob = c(0.2, 0.8))-1
ggplot(data, aes(x = factor(full_time))) +
  geom_bar(fill = "#0073C2FF", stat = "count")+
  scale_x_discrete(breaks=c(0,1), labels=c("Nie", "Tak"))+
  labs(title='Histogram zmiennej, określająca czy klient pracuje na pełen etat',x='', y="Częstość")+
  theme_minimal()
```
Zmienną, która z pewnością może okazać się istotna w tworzeniu modelu PD jest dochód roczny danej osoby. Wartości te zostały wylosowane z rozkładu normalnego. Średnia dla osób zatrudnionych na pełen etat została ustalona na poziomie 48000 USD z odchyleniem standardowym na poziomie 10000 USD. Dla osób niezatrudnionych na pełen etat wartość średnia została ustalona na poziomie 15000 USD, natomiast odchylenie 3000 USD. Poniżej zaprezentowano wykres gęstości tej zmiennej.

```{r, echo=F}
options(scipen=10000)
data$annual_income <- round(rnorm(5000,48000,10000),0)
data[data$full_time==0,"annual_income"] <- round(rnorm(nrow(data[data$full_time==0,]),15000,3000),0)
plot(density(data$annual_income), main='Wykres gęstości zarobków', ylab='Gęstość')
```
Kolejno, została wygenerowana zmienna, mówiąca o tym czy dana osoba jest singlem, czy żyje w związku z inną osobą. Prawdopodobieństwo, że ktoś jest singlem w Stanach Zjednoczoncyh wynosi 50.2 %. Przedstawiono histogram tej zmiennej w zbiorze.

```{r, echo=F}
data$single <- sample.int(2,5000,replace = T, prob = c(0.502, 0.498))-1
ggplot(data, aes(x = factor(single))) +
  geom_bar(fill = "#0073C2FF", stat = "count")+
  scale_x_discrete(breaks=c(0,1), labels=c("Nie", "Tak"))+
  labs(title='Histogram zmiennej, określająca czy klient jest singlem',x='', y="Częstość")+
  theme_minimal()
```

Następnie, została wygenerowana liczba posiadanych dzieci przez daną osobą. Zmienna ta została wygenerowana na podstawie zmiennej, określającej czy dana osoba jest singlem czy nie jest. Poniżej przedstawiono histogram tej wygenerowanej zmiennej.

```{r, echo=F}
data$kids <- round(rgamma(5000,shape=2,scale=0.8),0)
data[data$single==0, 'kids'] = round(rgamma(nrow(data[data$single==0,]),shape=1,scale=0.3),0)
data$single <- sample.int(2,5000,replace = T, prob = c(0.502, 0.498))-1
ggplot(data, aes(x = factor(kids))) +
  geom_bar(fill = "#0073C2FF", stat = "count")+
  labs(title='Histogram liczby posiadanych dzieci',x='', y="Częstość")+
  theme_minimal()
```

Kolejno, została wygenerowana zmienna, mówiąca o liczbie posiadanych samochodów przez klienta. Dla osób nieposiadających dzieci lub mających jedno dziecko, liczba ta została wylosowana z następującego zakresu: [0, 1, 2] z prawdopodobieństwami równymi kolejno: [40%, 50%, 10%]. Dla klientów mających więcej niż jedno dziecko, liczba samochodów zależy od liczby posiadanych dzieci i jest obliczona za pomocą następującej formuły: liczba_dzieci - [wartość z losowania liczb [1,2] z 50% prawdopodobieństwami] + 1. Poniżej przedstawiono histogram liczby posiadanych samochodów przez klientów.

```{r, echo=F}


data$car <- sample.int(3,5000,replace = T, prob=c(0.4, 0.5, 0.1))-1
data[data$kids>1,"car"] <- data$kids[data$kids>1] - sample.int(2,nrow(data[data$kids>1,]),replace = T)+1
ggplot(data, aes(x = factor(car))) +
  geom_bar(fill = "#0073C2FF", stat = "count")+
  labs(title='Histogram liczby posiadanych samochodów',x='', y="Częstość")+
  theme_minimal()
```

Następnie, została wygenerowana zmienna, określająca sektor gospodarki, w którym pracują klienci. Prawdopodobieństwo wystąpienia następujących sektorów [rolnictwo, przemysł, usługi] wśród zatrudnionych wynosi kolejno: [20%, 30%, 50%]. Poniżej przedstawiono histogram sektorów gospodarki. 

```{r, echo=F}
# data$sector <- "Brak zatrudnienia"
data[data$employed==1, 'sector'] <- sample.int(3,nrow(data[data$employed==1,]),replace = T, prob = c(0.2,0.3,0.5))
ggplot(data%>%filter(employed==1), aes(x = factor(sector))) +
  geom_bar(fill = "#0073C2FF", stat = "count")+
  labs(title='Histogram sektorów gospodarki',x='', y="Częstość")+
  theme_minimal() +
  scale_x_discrete(labels=c('Rolnictwo', 'Przemysł', 'Usługi'))
```
# Badanie rozkładów zmiennych
W celu sprawdzenia czy zmienne objaśniajce mają wiele wartości odstających, zbadano kurtozę każdej zmiennej ciągłej. Przyjęto, że dla tej miary spłaszczenia tolerowaną wartością będzie 3. 

```{r, echo=F}
contin_vars <- data%>%
  select(value_mortgage,value_nonmortgage,age,annual_income,kids,car)
y <- c()
kurtozy <- function (x)
{
  for (i in 1:ncol(x)) {
   y[i] <- kurtosis(x[i])
  }
  y
}

kable(t(kurtozy(contin_vars)),col.names = names(contin_vars), caption="Zestawienie wartości kurtozy zmiennych objaśniających")

```
Z powyższej tabeli wynika, że dla wartości kredytu hipotecznego oraz wartości kredytu bez hipoteki kurtozy wyniosły ok. 5.5. Nieco większą wartość przyjęła ta miara dla zmiennych liczby dzieci- 6.3, a największą dla liczby aut pracownika- 7.2. Dla pozostałych zmiennych ciągłych możemy przyjąć normalność rozkładów.

# Winsoryzacja zmiennych zaburzonych nietypowymi wartosciami

Podczas procesu winsoryzacji wartości odstające nie są usuwane, a jedynie podmieniane na ostatnie wartości znajdujące się w nieobciętym obszarze, dzięki czemu nie tracimy liczby obserwacji. W tym przypadku odcięte zostały skrajne obszary 5-procentowe. Poniższa tabela prezentuje wartości kurtozy po winsoryzacji tych czterech zmiennych ciągłych, których wspomniana miara spłaszczenia była większa od 3.
```{r, echo=F}
winsor1 <- function (x, fraction=.05)
{
  if(length(fraction) != 1 || fraction < 0 ||
     fraction > 0.5) {
    stop("bad value for 'fraction'")
  }
  lim <- quantile(x, probs=c(fraction, 1-fraction))
  x[ x < lim[1] ] <- lim[1]
  x[ x > lim[2] ] <- lim[2]
  x
}

data$value_mortgage_win <- winsor1(data$value_mortgage)
data$value_nonmortgage_win <- winsor1(data$value_nonmortgage)
data$kids_win <- winsor1(data$kids)
data$car_win <- winsor1(data$car)
conti_win <- data%>%
  select(value_mortgage_win,value_nonmortgage_win, kids_win, car_win)

kable(t(kurtozy(conti_win)),col.names = names(conti_win), caption="Wartości kurtozy zmiennych po winsoryzacji")

```
Można zauważyć znaczną poprawę rozkładów zmiennych, co pozytywnie wpłynie na dalszą analizę.
```{r, echo=F}
test_prop <- 0.3
test.set.index <- (runif(nrow(data)) < test_prop)
test <- data[test.set.index, ]
train <- data[!test.set.index, ]

summary(train)
summary(test)
names(data)
model <- glm(default ~ value_mortgage_win+value_nonmortgage_win+ age+employed+full_time+annual_income+single+kids_win+car_win, family = binomial(link = 'logit'), data = train)
summary(model)
```
